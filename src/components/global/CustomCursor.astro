---
---

<div id="custom-cursor" class="hidden lg:block">
  <div id="cursor-dot" class="cursor-dot"></div>
  <div id="cursor-circle" class="cursor-circle"></div>
  <span id="cursor-label" class="cursor-label"></span>
</div>

<script>
  import gsap from 'gsap';

  let cleanupFn: (() => void) | null = null;

  function initCursor() {
    cleanupFn?.();
    cleanupFn = null;

    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    if (isTouch || window.innerWidth < 1024) return;

    const dot = document.getElementById('cursor-dot');
    const circle = document.getElementById('cursor-circle');
    const label = document.getElementById('cursor-label');
    if (!dot || !circle || !label) return;

    const ac = new AbortController();
    const { signal } = ac;

    let mouseX = 0;
    let mouseY = 0;
    let dotX = 0;
    let dotY = 0;
    let circleX = 0;
    let circleY = 0;
    let destroyed = false;
    let rafId: number;

    // Hide default cursor
    document.body.style.cursor = 'none';

    document.addEventListener('mousemove', (e) => {
      mouseX = e.clientX;
      mouseY = e.clientY;
    }, { signal });

    function animate() {
      if (destroyed) return;

      // Dot follows immediately with slight smoothing
      dotX += (mouseX - dotX) * 0.2;
      dotY += (mouseY - dotY) * 0.2;
      dot.style.transform = `translate(${dotX - 4}px, ${dotY - 4}px)`;

      // Circle follows with more lag
      circleX += (mouseX - circleX) * 0.08;
      circleY += (mouseY - circleY) * 0.08;
      circle.style.transform = `translate(${circleX - 20}px, ${circleY - 20}px)`;

      // Label follows circle
      label.style.transform = `translate(${circleX + 24}px, ${circleY - 6}px)`;

      rafId = requestAnimationFrame(animate);
    }
    rafId = requestAnimationFrame(animate);

    // Handle hover states
    const interactiveElements = document.querySelectorAll('a, button, [data-cursor]');

    interactiveElements.forEach((el) => {
      el.addEventListener('mouseenter', () => {
        circle.classList.add('is-hovering');
        const cursorType = (el as HTMLElement).dataset.cursor;
        if (cursorType) {
          label.textContent = cursorType;
          label.style.opacity = '1';
        }
      }, { signal });
      el.addEventListener('mouseleave', () => {
        circle.classList.remove('is-hovering');
        label.style.opacity = '0';
        label.textContent = '';
      }, { signal });
    });

    // Magnetic hover for premium CTA feel
    const magneticItems = document.querySelectorAll<HTMLElement>('[data-magnetic]');
    magneticItems.forEach((item) => {
      const strength = Number(item.dataset.magnetic || '0.3');
      const xTo = gsap.quickTo(item, 'x', { duration: 0.4, ease: 'power3.out' });
      const yTo = gsap.quickTo(item, 'y', { duration: 0.4, ease: 'power3.out' });
      let bounds: DOMRect | null = null;

      const handleEnter = () => {
        bounds = item.getBoundingClientRect();
      };

      const handleMove = (e: MouseEvent) => {
        if (!bounds) bounds = item.getBoundingClientRect();
        const relX = e.clientX - bounds.left - bounds.width / 2;
        const relY = e.clientY - bounds.top - bounds.height / 2;
        xTo(relX * strength);
        yTo(relY * strength);
      };

      const handleLeave = () => {
        xTo(0);
        yTo(0);
      };

      item.addEventListener('mouseenter', handleEnter, { signal });
      item.addEventListener('mousemove', handleMove, { signal });
      item.addEventListener('mouseleave', handleLeave, { signal });
    });

    cleanupFn = () => {
      destroyed = true;
      cancelAnimationFrame(rafId);
      ac.abort();
      document.body.style.cursor = '';
      magneticItems.forEach((item) => {
        item.style.transform = '';
      });
    };
  }

  initCursor();
  document.addEventListener('astro:after-swap', initCursor);
</script>
