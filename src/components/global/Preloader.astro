---
import { getLangFromUrl } from '../../i18n/translations';

const lang = getLangFromUrl(Astro.url);
---

<div id="preloader" class="preloader">
  <!-- Logo -->
  <div class="preloader-logo">
    <svg
      width="80"
      height="80"
      viewBox="0 0 500 500"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <!-- Top-left bracket -->
      <path
        id="preloader-bracket-tl"
        d="M100 400H0V1H400V100H100V400Z"
        fill="var(--color-text)"
      />
      <!-- Bottom-right bracket -->
      <path
        id="preloader-bracket-br"
        d="M400 100H500L500 499L100 499V400L400 400L400 100Z"
        fill="var(--color-text)"
      />
    </svg>
  </div>

  <!-- Language picker -->
  <div id="preloader-lang" class="preloader-lang">
    <a
      href="/en/"
      class={`preloader-lang-option ${lang === 'en' ? 'is-active' : ''}`}
      data-lang="en"
    >EN</a>
    <span class="preloader-lang-divider">/</span>
    <a
      href="/pl/"
      class={`preloader-lang-option ${lang === 'pl' ? 'is-active' : ''}`}
      data-lang="pl"
    >PL</a>
  </div>

  <!-- Loading counter (hidden until language is chosen) -->
  <div class="preloader-counter" id="preloader-counter" style="display: none;">
    <span id="preloader-percent">0</span>%
  </div>

  <!-- Horizontal expanding line -->
  <div
    id="preloader-line"
    class="absolute left-1/2 top-1/2 h-px bg-[var(--color-text-ghost)] -translate-x-1/2"
    style="width: 0"
  ></div>
</div>

<script>
  import gsap from 'gsap';

  function initPreloader() {
    const preloader = document.getElementById('preloader');
    const percentEl = document.getElementById('preloader-percent');
    const lineEl = document.getElementById('preloader-line');
    const bracketTL = document.getElementById('preloader-bracket-tl');
    const bracketBR = document.getElementById('preloader-bracket-br');

    if (!preloader || !percentEl || !bracketTL || !bracketBR || !lineEl) return;

    // Start both brackets invisible (scaled down from their origin corner)
    gsap.set(bracketTL, { opacity: 0, scale: 0.6, transformOrigin: '0% 0%' });
    gsap.set(bracketBR, { opacity: 0, scale: 0.6, transformOrigin: '100% 100%' });

    // Master timeline
    const tl = gsap.timeline({
      onComplete: () => {
        preloader.classList.add('is-done');
      },
    });

    // 1. Reveal the brackets (scale + fade in from their corners)
    tl.to(bracketTL, {
      opacity: 1,
      scale: 1,
      duration: 0.8,
      ease: 'power2.out',
    });

    tl.to(bracketBR, {
      opacity: 1,
      scale: 1,
      duration: 0.8,
      ease: 'power2.out',
    }, '-=0.6');

    // 2. Count up percentage (overlapping with bracket reveal)
    tl.to(
      { val: 0 },
      {
        val: 100,
        duration: 1.5,
        ease: 'power1.inOut',
        onUpdate: function () {
          percentEl.textContent = Math.round(this.targets()[0].val).toString();
        },
      },
      0.2
    );

    // 3. Flash brackets to accent color
    tl.to([bracketTL, bracketBR], {
      fill: '#DA382E',
      duration: 0.4,
      ease: 'power2.in',
    }, '-=0.3');

    // 4. Expand the line
    tl.to(lineEl, {
      width: '100vw',
      duration: 0.6,
      ease: 'power3.inOut',
    }, '-=0.2');

    // 5. Wipe away preloader
    tl.to(preloader, {
      clipPath: 'inset(0 0 100% 0)',
      duration: 0.8,
      ease: 'power3.inOut',
    });

    // 6. Clean up
    tl.call(() => {
      preloader.style.display = 'none';
      document.body.style.overflow = '';

      // Trigger hero animations
      document.dispatchEvent(new CustomEvent('preloader:complete'));
    });
  }

  function startAnimation() {
    // Hide language picker, show counter
    const langPicker = document.getElementById('preloader-lang');
    const counter = document.getElementById('preloader-counter');
    if (langPicker) langPicker.style.display = 'none';
    if (counter) counter.style.display = '';

    // Wait for fonts, but start after 3s max to avoid getting stuck
    const fontTimeout = new Promise(resolve => setTimeout(resolve, 3000));
    Promise.race([document.fonts.ready, fontTimeout]).then(() => {
      initPreloader();
      sessionStorage.setItem('preloaded', 'true');
      sessionStorage.removeItem('lang-chosen');
    });
  }

  function setupLangPicker() {
    const langPicker = document.getElementById('preloader-lang');
    if (!langPicker) return;

    const options = langPicker.querySelectorAll('.preloader-lang-option');
    const currentLang = document.documentElement.lang || 'en';

    options.forEach(option => {
      option.addEventListener('click', (e) => {
        const selectedLang = (option as HTMLElement).dataset.lang;

        if (selectedLang === currentLang) {
          // Same language — start animation immediately
          e.preventDefault();
          sessionStorage.setItem('lang-chosen', 'true');
          startAnimation();
        } else {
          // Different language — set flag, let the link navigate
          sessionStorage.setItem('lang-chosen', 'true');
        }
      });
    });
  }

  function initPage() {
    if (!sessionStorage.getItem('preloaded')) {
      document.body.style.overflow = 'hidden';

      if (sessionStorage.getItem('lang-chosen')) {
        // Language was already chosen (user switched locale) — auto-start animation
        startAnimation();
      } else {
        // First visit — show language picker and wait for selection
        setupLangPicker();
      }
    } else {
      // Skip preloader on subsequent navigations
      const preloader = document.getElementById('preloader');
      if (preloader) {
        preloader.style.display = 'none';
      }
      // Trigger hero animations immediately
      requestAnimationFrame(() => {
        document.dispatchEvent(new CustomEvent('preloader:complete'));
      });
    }
  }

  // Run on initial load
  initPage();

  // Re-run after Astro view transitions (ClientRouter soft navigations)
  document.addEventListener('astro:page-load', initPage);
</script>
