---
import { getLangFromUrl } from '../../i18n/translations';

const lang = getLangFromUrl(Astro.url);
---

<div id="preloader" class="preloader">
  <!-- Content layer (logo, lang picker, counter) -->
  <div id="preloader-content" class="preloader-content">
    <!-- Logo -->
    <div class="preloader-logo">
      <svg
        width="80"
        height="80"
        viewBox="0 0 500 500"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <!-- Top-left bracket -->
        <path
          id="preloader-bracket-tl"
          d="M100 400H0V1H400V100H100V400Z"
          fill="var(--color-text)"
        />
        <!-- Bottom-right bracket -->
        <path
          id="preloader-bracket-br"
          d="M400 100H500L500 499L100 499V400L400 400L400 100Z"
          fill="var(--color-text)"
        />
      </svg>
    </div>

    <!-- Language picker -->
    <div id="preloader-lang" class="preloader-lang">
      <a
        href="/en/"
        class={`preloader-lang-option ${lang === 'en' ? 'is-active' : ''}`}
        data-lang="en"
      >EN</a>
      <span class="preloader-lang-divider">/</span>
      <a
        href="/pl/"
        class={`preloader-lang-option ${lang === 'pl' ? 'is-active' : ''}`}
        data-lang="pl"
      >PL</a>
    </div>

    <!-- Loading counter (hidden until language is chosen) -->
    <div class="preloader-counter" id="preloader-counter" style="display: none;">
      <span id="preloader-percent">0</span>%
    </div>
  </div>

  <!-- Horizontal expanding line -->
  <div
    id="preloader-line"
    class="absolute left-1/2 top-1/2 h-px bg-[var(--color-text-ghost)] -translate-x-1/2"
    style="width: 0"
  ></div>

  <!-- Split halves for center-out reveal -->
  <div id="preloader-top" class="preloader-half preloader-half--top"></div>
  <div id="preloader-bottom" class="preloader-half preloader-half--bottom"></div>
</div>

<script>
  import gsap from 'gsap';

  let cleanupFn: (() => void) | null = null;
  const timelines: gsap.core.Timeline[] = [];

  function runExitAnimation() {
    const preloader = document.getElementById('preloader');
    const content = document.getElementById('preloader-content');
    const percentEl = document.getElementById('preloader-percent');
    const lineEl = document.getElementById('preloader-line');
    const bracketTL = document.getElementById('preloader-bracket-tl');
    const bracketBR = document.getElementById('preloader-bracket-br');
    const topHalf = document.getElementById('preloader-top');
    const bottomHalf = document.getElementById('preloader-bottom');

    if (!preloader || !content || !percentEl || !bracketTL || !bracketBR || !lineEl || !topHalf || !bottomHalf) return;

    // Brackets start visible (already on screen from picker or entrance)
    gsap.set(bracketTL, { opacity: 1, scale: 1 });
    gsap.set(bracketBR, { opacity: 1, scale: 1 });

    const tl = gsap.timeline();
    timelines.push(tl);

    // 1. Count up percentage
    tl.to(
      { val: 0 },
      {
        val: 100,
        duration: 1.2,
        ease: 'power1.inOut',
        onUpdate: function () {
          percentEl.textContent = Math.round(this.targets()[0].val).toString();
        },
      },
    );

    // 2. Expand line from center to full width
    tl.to(lineEl, {
      width: '100vw',
      duration: 0.7,
      ease: 'power2.inOut',
    }, '-=0.3');

    // 3. Fade out content (logo + counter)
    tl.to(content, {
      opacity: 0,
      duration: 0.3,
      ease: 'power2.in',
    });

    // 4. Remove preloader bg so page shows between the halves, then split
    tl.set(preloader, { background: 'transparent' });

    tl.to(topHalf, {
      yPercent: -100,
      duration: 0.8,
      ease: 'power3.inOut',
    });

    tl.to(bottomHalf, {
      yPercent: 100,
      duration: 0.8,
      ease: 'power3.inOut',
    }, '<');

    // Fade out the line with the split
    tl.to(lineEl, {
      opacity: 0,
      duration: 0.3,
    }, '<');

    // 5. Clean up
    tl.call(() => {
      preloader.style.display = 'none';
      document.body.style.overflow = '';
      document.dispatchEvent(new CustomEvent('preloader:complete'));
    });
  }

  function runEntranceAndExit() {
    // Used after language navigation — animate the preloader IN, then OUT
    const preloader = document.getElementById('preloader');
    const content = document.getElementById('preloader-content');
    const langPicker = document.getElementById('preloader-lang');
    const counter = document.getElementById('preloader-counter');
    const bracketTL = document.getElementById('preloader-bracket-tl');
    const bracketBR = document.getElementById('preloader-bracket-br');

    if (!preloader || !content || !bracketTL || !bracketBR) return;

    // Hide lang picker, show counter
    if (langPicker) langPicker.style.display = 'none';
    if (counter) counter.style.display = '';

    // Start with content invisible — animate it in
    gsap.set(content, { opacity: 0 });
    gsap.set(bracketTL, { opacity: 0, scale: 0.8, transformOrigin: '0% 0%' });
    gsap.set(bracketBR, { opacity: 0, scale: 0.8, transformOrigin: '100% 100%' });

    const tl = gsap.timeline();
    timelines.push(tl);

    // Entrance: fade in brackets
    tl.to(bracketTL, {
      opacity: 1,
      scale: 1,
      duration: 0.5,
      ease: 'power2.out',
    });

    tl.to(bracketBR, {
      opacity: 1,
      scale: 1,
      duration: 0.5,
      ease: 'power2.out',
    }, '-=0.3');

    // Fade in the counter
    tl.to(content, {
      opacity: 1,
      duration: 0.3,
      ease: 'power2.out',
    }, '-=0.3');

    // Then run the exit
    tl.call(() => {
      runExitAnimation();
    }, undefined, '+=0.1');
  }

  function startAnimation(ac: AbortController) {
    // Hide language picker, show counter
    const langPicker = document.getElementById('preloader-lang');
    const counter = document.getElementById('preloader-counter');
    if (langPicker) langPicker.style.display = 'none';
    if (counter) counter.style.display = '';

    // Wait for fonts, then run exit animation
    const fontTimeout = new Promise(resolve => setTimeout(resolve, 3000));
    Promise.race([document.fonts.ready, fontTimeout]).then(() => {
      if (ac.signal.aborted) return;
      runExitAnimation();
      localStorage.setItem('preloaded', 'true');
      localStorage.removeItem('lang-chosen');
    });
  }

  function startEntranceAnimation(ac: AbortController) {
    // Wait for fonts, then run entrance + exit
    const fontTimeout = new Promise(resolve => setTimeout(resolve, 3000));
    Promise.race([document.fonts.ready, fontTimeout]).then(() => {
      if (ac.signal.aborted) return;
      runEntranceAndExit();
      localStorage.setItem('preloaded', 'true');
      localStorage.removeItem('lang-chosen');
    });
  }

  function setupLangPicker(ac: AbortController) {
    const langPicker = document.getElementById('preloader-lang');
    if (!langPicker) return;

    const options = langPicker.querySelectorAll('.preloader-lang-option');
    const currentLang = document.documentElement.lang || 'en';

    options.forEach(option => {
      option.addEventListener('click', (e) => {
        const selectedLang = (option as HTMLElement).dataset.lang;

        localStorage.setItem('preferred-lang', selectedLang!);

        if (selectedLang === currentLang) {
          // Same language — start exit animation immediately
          e.preventDefault();
          localStorage.setItem('lang-chosen', 'true');
          startAnimation(ac);
        } else {
          // Different language — set flag, let the link navigate
          localStorage.setItem('lang-chosen', 'true');
        }
      }, { signal: ac.signal });
    });
  }

  function initPage() {
    cleanupFn?.();
    cleanupFn = null;

    const ac = new AbortController();

    if (!localStorage.getItem('preloaded')) {
      document.body.style.overflow = 'hidden';

      if (localStorage.getItem('lang-chosen')) {
        // Arrived after language switch — animate in, then out
        startEntranceAnimation(ac);
      } else {
        // First visit — show language picker and wait for selection
        setupLangPicker(ac);
      }
    } else {
      // Skip preloader on subsequent visits — hide it explicitly
      // (the <head> inline script handles full page loads, but Astro view
      // transitions swap the DOM so we must also hide it here)
      const preloader = document.getElementById('preloader');
      if (preloader) preloader.style.display = 'none';
      document.dispatchEvent(new CustomEvent('preloader:complete'));
    }

    cleanupFn = () => {
      ac.abort();
      timelines.forEach(tl => tl.kill());
      timelines.length = 0;
    };
  }

  // Run on initial load
  initPage();

  // Re-run after Astro view transitions (ClientRouter soft navigations)
  document.addEventListener('astro:page-load', initPage);
</script>
