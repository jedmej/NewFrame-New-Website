---
import type { Lang } from '../../i18n/translations';
import { useTranslations, getAlternateUrl } from '../../i18n/translations';

interface Props {
  lang: Lang;
}

const { lang } = Astro.props;
const t = useTranslations(lang);
const altLang = lang === 'en' ? 'pl' : 'en';
const altUrl = getAlternateUrl(Astro.url, altLang);
---

<nav
  id="main-nav"
  class="fixed top-0 left-0 w-full z-[100] flex items-center justify-between px-4 py-5 lg:grid lg:grid-cols-[1fr_auto_1fr] lg:px-10 transition-transform duration-500 text-[var(--color-text)] glass"
  style="opacity: 0"
>
  <!-- Left: Logo -->
  <div class="flex items-center">
    <a
      href={`/${lang}/`}
      id="logo-link"
      class="group flex items-center gap-3 relative overflow-hidden"
      transition:name="logo"
      style="height: 1.35rem;"
    >
      <span id="logo-text" class="text-sm font-semibold tracking-tight uppercase block" style="font-family: var(--font-display)">
        New Frame<sup class="text-[0.5em] align-super opacity-40 ml-0.5">Â®</sup>
      </span>
      <svg id="logo-icon" class="absolute left-1/2 -translate-x-1/2 w-auto block" style="height: 1.35rem; top: 100%;" viewBox="0 0 500 500" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="300" height="100" transform="matrix(-1 0 0 1 400 400)" fill="currentColor"/>
        <rect width="100" height="400" transform="matrix(-1 0 0 1 500 100)" fill="currentColor"/>
        <rect width="300" height="100" transform="matrix(1 0 0 -1 100 100)" fill="currentColor"/>
        <rect width="100" height="400" transform="matrix(1 0 0 -1 0 400)" fill="currentColor"/>
      </svg>
    </a>
  </div>

  <!-- Center: Desktop Nav Links -->
  <div class="hidden lg:flex items-center gap-10">
    <a href={`/${lang}/#work`} class="nav-link text-mono-xs opacity-60 hover:opacity-100 hover:text-[var(--color-accent)] transition-all duration-300">
      {t.nav.work}
    </a>
    <a href={`/${lang}/#scope`} class="nav-link text-mono-xs opacity-60 hover:opacity-100 hover:text-[var(--color-accent)] transition-all duration-300">
      {t.nav.scope}
    </a>
    <a href={`/${lang}/#services`} class="nav-link text-mono-xs opacity-60 hover:opacity-100 hover:text-[var(--color-accent)] transition-all duration-300">
      {t.nav.services}
    </a>
    <a href={`/${lang}/#contact`} class="nav-link text-mono-xs opacity-60 hover:opacity-100 hover:text-[var(--color-accent)] transition-all duration-300">
      {t.nav.contact}
    </a>
  </div>

  <!-- Right: CTA + Mobile Menu -->
  <div class="flex items-center justify-end gap-4">
    <!-- Availability Dot + Clock -->
    <div class="hidden lg:flex items-center gap-2 mr-4">
      <span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span>
      <span id="nav-clock" class="text-mono-xs opacity-30">--:-- CET</span>
    </div>

    <!-- Language Selector -->
    <a
      href={altUrl}
      class="nav-link hidden lg:inline-flex text-mono-xs opacity-40 hover:opacity-100 transition-opacity mr-2"
      data-lang-switch={altLang}
    >
      {altLang.toUpperCase()}
    </a>

    <!-- Let's Talk CTA -->
    <a
      href={`/${lang}/#contact`}
      class="nav-cta hidden lg:inline-flex items-center gap-2 text-mono-xs opacity-70 hover:opacity-100 hover:text-[var(--color-accent)] transition-all duration-300 group"
    >
      <span>{t.contact.cta}</span>
      <svg class="nav-cta-arrow w-3 h-3 transition-transform duration-300 ease-out" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M1 11L11 1M11 1H3M11 1V9"/>
      </svg>
    </a>

    <!-- Mobile Menu Button -->
    <button
      id="mobile-menu-btn"
      class="lg:hidden flex flex-col gap-1.5 p-2 -mr-2"
      aria-label="Open menu"
    >
      <span class="menu-line w-6 h-px transition-all duration-300 bg-[var(--color-text)]"></span>
      <span class="menu-line w-4 h-px transition-all duration-300 ml-auto bg-[var(--color-text)]"></span>
    </button>
  </div>
</nav>

<!-- Mobile Menu Overlay -->
<div
  id="mobile-menu"
  class="fixed inset-0 z-[99] bg-[var(--color-bg)] flex flex-col items-end justify-end px-4 pb-12 opacity-0 pointer-events-none transition-opacity duration-500"
>
  <div class="flex flex-col items-end gap-2">
    <a href={`/${lang}/#work`} class="mobile-menu-link text-display-lg text-right opacity-0 translate-y-8">{t.nav.work}</a>
    <a href={`/${lang}/#scope`} class="mobile-menu-link text-display-lg text-right opacity-0 translate-y-8">{t.nav.scope}</a>
    <a href={`/${lang}/#services`} class="mobile-menu-link text-display-lg text-right opacity-0 translate-y-8">{t.nav.services}</a>
    <a href={`/${lang}/#contact`} class="mobile-menu-link text-display-lg text-right opacity-0 translate-y-8">{t.nav.contact}</a>
  </div>
  <div class="flex items-center gap-6 mt-10 opacity-0 translate-y-8 mobile-menu-link">
    <a href={altUrl} class="text-mono-sm opacity-60 hover:opacity-100 transition-opacity" data-lang-switch={altLang}>
      {altLang.toUpperCase()}
    </a>
  </div>
</div>

<script>
  import gsap from 'gsap';
  import { ScrambleTextPlugin } from 'gsap/ScrambleTextPlugin';

  gsap.registerPlugin(ScrambleTextPlugin);

  let cleanupFn: (() => void) | null = null;

  function initNav() {
    cleanupFn?.();
    cleanupFn = null;

    const nav = document.getElementById('main-nav');
    if (!nav) return;

    const ac = new AbortController();
    const { signal } = ac;
    let intervalId: ReturnType<typeof setInterval> | null = null;
    let menuCloseTimeout: ReturnType<typeof setTimeout>;

    // Entrance animation on page load
    gsap.to(nav, { opacity: 1, duration: 1, ease: 'power2.out', delay: 0.3 });

    // Scramble text on hover for nav links
    nav.querySelectorAll('.nav-link, .nav-cta span').forEach((el) => {
      const original = el.textContent || '';
      el.addEventListener('mouseenter', () => {
        gsap.to(el, {
          duration: 0.5,
          scrambleText: { text: original, chars: 'abcdefghijklmnopqrstuvwxyz', speed: 0.4 },
        });
      }, { signal });
    });

    // Animate CTA arrow: rotate to point right on hover
    const ctaLink = nav.querySelector('.nav-cta');
    const ctaArrow = nav.querySelector('.nav-cta-arrow');
    if (ctaLink && ctaArrow) {
      ctaLink.addEventListener('mouseenter', () => {
        gsap.to(ctaArrow, { rotation: 45, duration: 0.3, ease: 'power2.out' });
      }, { signal });
      ctaLink.addEventListener('mouseleave', () => {
        gsap.to(ctaArrow, { rotation: 0, duration: 0.3, ease: 'power2.out' });
      }, { signal });
    }

    // Logo hover: text slides up, SVG slides in from bottom
    const logoLink = document.getElementById('logo-link');
    const logoText = document.getElementById('logo-text');
    const logoIcon = document.getElementById('logo-icon');

    if (logoLink && logoText && logoIcon) {
      let logoTl: gsap.core.Timeline | null = null;

      logoLink.addEventListener('mouseenter', () => {
        if (logoTl) logoTl.kill();
        logoTl = gsap.timeline()
          .to(logoText, {
            y: '-100%',
            opacity: 0,
            duration: 0.25,
            ease: 'power3.in',
          })
          .fromTo(logoIcon,
            { y: '0%', opacity: 0 },
            {
              y: '-100%',
              opacity: 1,
              duration: 0.3,
              ease: 'power3.out',
            },
            '>-0.05'
          );
      }, { signal });

      logoLink.addEventListener('mouseleave', () => {
        if (logoTl) logoTl.kill();
        logoTl = gsap.timeline()
          .to(logoIcon, {
            y: '0%',
            opacity: 0,
            duration: 0.25,
            ease: 'power3.in',
          })
          .to(logoText, {
            y: '0%',
            opacity: 1,
            duration: 0.3,
            ease: 'power3.out',
          }, '>-0.05');
      }, { signal });
    }

    // Clock
    const clockEl = document.getElementById('nav-clock');
    if (clockEl) {
      const updateClock = () => {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-GB', {
          hour: '2-digit',
          minute: '2-digit',
          timeZone: 'Europe/Warsaw',
        });
        clockEl.textContent = `${timeStr} CET`;
      };
      updateClock();
      intervalId = setInterval(updateClock, 60000);
    }

    // Mobile menu
    const menuBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    const menuLines = menuBtn?.querySelectorAll('.menu-line');
    const menuLinks = mobileMenu?.querySelectorAll('.mobile-menu-link');
    let menuOpen = false;

    menuBtn?.addEventListener('click', () => {
      menuOpen = !menuOpen;

      if (menuOpen) {
        mobileMenu!.style.opacity = '1';
        mobileMenu!.style.pointerEvents = 'all';
        document.body.style.overflow = 'hidden';

        // Animate lines to X
        gsap.to(menuLines![0], { rotation: 45, y: 4, width: 24, duration: 0.3 });
        gsap.to(menuLines![1], { rotation: -45, y: -4, width: 24, marginLeft: 0, duration: 0.3 });

        // Stagger links in
        gsap.to(menuLinks!, {
          opacity: 1,
          y: 0,
          duration: 0.6,
          stagger: 0.08,
          ease: 'power3.out',
          delay: 0.1,
        });
      } else {
        gsap.to(menuLinks!, { opacity: 0, y: 8, duration: 0.3, stagger: 0.03 });
        gsap.to(menuLines![0], { rotation: 0, y: 0, duration: 0.3 });
        gsap.to(menuLines![1], { rotation: 0, y: 0, width: 16, marginLeft: 'auto', duration: 0.3 });

        menuCloseTimeout = setTimeout(() => {
          mobileMenu!.style.opacity = '0';
          mobileMenu!.style.pointerEvents = 'none';
          document.body.style.overflow = '';
        }, 400);
      }
    }, { signal });

    // Store language preference when switching via nav
    document.querySelectorAll('[data-lang-switch]').forEach(link => {
      link.addEventListener('click', () => {
        localStorage.setItem('preferred-lang', (link as HTMLElement).dataset.langSwitch!);
      }, { signal });
    });

    // Close menu on link click
    menuLinks?.forEach((link) => {
      link.addEventListener('click', () => {
        if (menuOpen) menuBtn?.click();
      }, { signal });
    });

    cleanupFn = () => {
      ac.abort();
      if (intervalId) clearInterval(intervalId);
      clearTimeout(menuCloseTimeout);
    };
  }

  // Init on page load and after view transitions
  initNav();
  document.addEventListener('astro:after-swap', initNav);
</script>
