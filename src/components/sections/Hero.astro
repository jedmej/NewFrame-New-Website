---
import type { Lang } from '../../i18n/translations';
import { useTranslations } from '../../i18n/translations';

interface Props {
  lang: Lang;
}

const { lang } = Astro.props;
const t = useTranslations(lang);
---

<section
  id="hero"
  class="relative w-full h-screen flex flex-col justify-center items-center overflow-hidden"
  style="background-color: var(--color-bg);"
>
  <!-- Main content -->
  <div class="relative w-full h-full px-6 md:px-10 flex flex-col justify-center max-w-[2000px] mx-auto">

    <!-- Title â€” centered, dominant -->
    <div class="flex flex-col items-center justify-center">
      <h1
        id="hero-title"
        class="text-display-xl text-center text-[var(--color-text)] select-none"
        aria-label={t.hero.title}
      >
        {t.hero.title}
      </h1>
    </div>

    <!-- Corner metadata: top -->
    <div class="absolute top-[15%] left-[8%] right-[8%] flex flex-col items-center gap-2 md:flex-row md:justify-between md:items-start">
      <!-- Top-left: availability -->
      <div id="hero-corner-tl" class="flex items-center gap-2 opacity-0">
        <span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span>
        <span class="text-mono-xs text-[var(--color-text-subtle)]">{t.hero.available}</span>
      </div>
      <!-- Top-right: location -->
      <div id="hero-corner-tr" class="opacity-0">
        <span class="text-mono-xs text-[var(--color-text-subtle)]">{t.hero.location}</span>
      </div>
    </div>

    <!-- Corner metadata: bottom -->
    <div class="absolute bottom-[15%] left-[8%] right-[8%] flex flex-col items-center gap-2 md:flex-row md:justify-between md:items-end">
      <!-- Bottom-left: descriptor -->
      <div id="hero-corner-bl" class="opacity-0">
        <span class="text-mono-xs text-[var(--color-text-subtle)]">{t.hero.descriptor}</span>
      </div>
      <!-- Bottom-right: credit -->
      <div id="hero-corner-br" class="opacity-0">
        <span class="text-mono-xs text-[var(--color-text-subtle)]">{t.hero.credit}</span>
      </div>
    </div>
  </div>
</section>

<script>
  import gsap from 'gsap';
  import { SplitText } from 'gsap/SplitText';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(SplitText, ScrollTrigger);

  let cleanupFn: (() => void) | null = null;

  function initHero() {
    cleanupFn?.();
    cleanupFn = null;

    const titleEl = document.getElementById('hero-title');
    if (!titleEl) return;

    const ac = new AbortController();
    const { signal } = ac;
    const scrollTriggers: ScrollTrigger[] = [];

    // Split title into characters
    const split = new SplitText(titleEl, {
      type: 'chars',
      charsClass: 'split-char',
    });

    const corners = [
      document.getElementById('hero-corner-tl'),
      document.getElementById('hero-corner-tr'),
      document.getElementById('hero-corner-bl'),
      document.getElementById('hero-corner-br'),
    ].filter(Boolean);

    // Entrance timeline triggered by preloader
    let entranceTl: gsap.core.Timeline | null = null;
    function playEntrance() {
      entranceTl = gsap.timeline();
      const tl = entranceTl;

      // Characters animate in from below with stagger
      tl.from(split.chars, {
        y: 120,
        opacity: 0,
        rotateX: -80,
        stagger: 0.03,
        duration: 1,
        ease: 'power4.out',
      });

      // Corner labels fade in
      tl.to(corners, {
        opacity: 1,
        duration: 0.8,
        stagger: 0.1,
        ease: 'power2.out',
      }, '-=0.3');
    }

    // Listen for preloader completion
    document.addEventListener('preloader:complete', playEntrance, { once: true, signal });

    // Scroll-driven parallax: characters spread apart
    if (split.chars && split.chars.length > 0) {
      split.chars.forEach((char: HTMLElement, i: number) => {
        const offset = (i - split.chars.length / 2) * 8;
        const tween = gsap.to(char, {
          x: offset,
          opacity: 0.3,
          scrollTrigger: {
            trigger: '#hero',
            start: 'top top',
            end: 'bottom top',
            scrub: 1,
          },
        });
        if (tween.scrollTrigger) scrollTriggers.push(tween.scrollTrigger);
      });
    }

    // Fade out hero on scroll
    const fadeTween = gsap.to('#hero', {
      opacity: 0,
      scrollTrigger: {
        trigger: '#hero',
        start: '60% top',
        end: 'bottom top',
        scrub: 1,
      },
    });
    if (fadeTween.scrollTrigger) scrollTriggers.push(fadeTween.scrollTrigger);

    cleanupFn = () => {
      ac.abort();
      entranceTl?.kill();
      scrollTriggers.forEach((st) => st.kill());
      split.revert();
    };
  }

  initHero();
  document.addEventListener('astro:after-swap', initHero);
</script>
