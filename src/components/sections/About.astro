---
import type { Lang } from '../../i18n/translations';
import { useTranslations } from '../../i18n/translations';

interface Props {
  lang: Lang;
}

const { lang } = Astro.props;
const t = useTranslations(lang);
---

<section
  id="scope"
  class="relative min-h-screen border-t border-[var(--color-border)]"
  style="background-color: var(--color-bg);"
>
  <div class="w-full px-6 md:px-10 max-w-[1400px] mx-auto py-24 md:py-32 lg:py-40">

    <!-- Section label -->
    <div class="mb-8 md:mb-12">
      <h2 class="text-mono-xs text-[#0A0A0A]">{t.about.label}</h2>
      <div class="mt-4 w-full h-px bg-[var(--color-text)]"></div>
    </div>

    <!-- Full-width manifesto text -->
    <p
      id="manifesto-text"
      class="text-serif-display leading-[1.25]"
      style="color: var(--color-text); font-size: clamp(2.25rem, 3.75vw, 3.375rem);"
      data-highlights={JSON.stringify(t.about.manifestoHighlights)}
    >
      {t.about.manifesto}
    </p>

    <!-- Image + body text row -->
    <div class="about-lower flex flex-col md:flex-row md:justify-end gap-6 mt-12 md:mt-16 lg:mt-20">

      <!-- Image block -->
      <div class="about-image-wrapper w-full md:w-1/2 lg:w-[480px] flex-shrink-0">
        <div
          id="about-image-block"
          class="relative overflow-hidden"
          style="aspect-ratio: 3/4; background-color: var(--color-text);"
        >
          <!-- Unicorn Studio WebGL scene -->
          <div
            id="unicorn-container"
            data-us-project="ZDL0KUXvDVMNVAaFtwhX"
            role="img"
            aria-label="Decorative abstract visual"
            style="position: absolute; inset: 0; width: 100%; height: 100%;"
          ></div>

          <!-- Bottom-left detail -->
          <div class="absolute bottom-5 left-5 flex items-center gap-3 z-10">
            <span class="block w-6 h-px" style="background-color: var(--color-accent);"></span>
            <span class="text-mono-xs" style="color: rgba(255,255,255,0.35);">{t.about.founder}</span>
          </div>

          <!-- Top-right detail -->
          <div class="absolute top-5 right-5 z-10">
            <span class="text-mono-xs" style="color: rgba(255,255,255,0.2);">{t.about.role}</span>
          </div>
        </div>
      </div>

      <!-- Body text -->
      <div class="about-text-wrapper flex items-start">
        <p
          id="about-body"
          class="sticky top-32 md:top-40 text-sm md:text-sm leading-relaxed"
          style="font-family: var(--font-mono); color: var(--color-text-muted); letter-spacing: 0.02em; max-width: 420px;"
        >
          {t.about.body}
        </p>
      </div>

    </div>
  </div>
</section>

<style>
  .manifesto-word {
    display: inline-block;
    will-change: opacity;
  }

</style>

<script>
  import gsap from 'gsap';
  import { SplitText } from 'gsap/SplitText';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(SplitText, ScrollTrigger);

  let cleanupFn: (() => void) | null = null;

  function initAbout() {
    cleanupFn?.();
    cleanupFn = null;
    unicornAborted = false;

    const section = document.getElementById('scope');
    const textEl = document.getElementById('manifesto-text');
    const imageBlock = document.getElementById('about-image-block');
    const bodyEl = document.getElementById('about-body');
    if (!textEl || !section) return;

    const scrollTriggers: ScrollTrigger[] = [];
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const highlights = JSON.parse(textEl.dataset.highlights || '[]') as string[];

    // ===== Word-by-word manifesto reveal =====

    const split = new SplitText(textEl, {
      type: 'words',
      wordsClass: 'manifesto-word',
    });

    split.words.forEach((word: HTMLElement) => {
      word.style.opacity = prefersReducedMotion ? '1' : '0.08';
      word.style.transition = 'none';
      word.style.display = 'inline-block';

      const text = word.textContent?.replace(/[^a-zA-ZąćęłńóśźżĄĆĘŁŃÓŚŹŻ]/g, '') || '';
      if (highlights.some((h: string) => text.toLowerCase() === h.toLowerCase())) {
        word.dataset.highlight = 'true';
      }
    });

    if (!prefersReducedMotion) {
      // Word reveal on scroll
      const wordTween = gsap.to(split.words, {
        opacity: 1,
        stagger: 0.02,
        ease: 'none',
        scrollTrigger: {
          trigger: textEl,
          start: 'top 80%',
          end: 'bottom 40%',
          scrub: 1,
          onUpdate: (self) => {
            const revealed = Math.floor(self.progress * split.words.length);
            split.words.forEach((word: HTMLElement, i: number) => {
              if (i <= revealed && word.dataset.highlight === 'true') {
                word.style.color = 'var(--color-accent)';
              }
            });
          },
        },
      });
      if (wordTween.scrollTrigger) scrollTriggers.push(wordTween.scrollTrigger);

      // Image block parallax — slightly different rate than text for organic feel
      if (imageBlock) {
        const imgTween = gsap.fromTo(imageBlock,
          { y: 50 },
          {
            y: -40,
            scrollTrigger: {
              trigger: imageBlock,
              start: 'top bottom',
              end: 'bottom top',
              scrub: 1,
            },
          }
        );
        if (imgTween.scrollTrigger) scrollTriggers.push(imgTween.scrollTrigger);
      }

      // Body text reveal
      if (bodyEl) {
        const bodyTween = gsap.fromTo(bodyEl,
          { opacity: 0, y: 20 },
          {
            opacity: 1,
            y: 0,
            duration: 1,
            ease: 'power2.out',
            scrollTrigger: {
              trigger: bodyEl,
              start: 'top 85%',
              once: true,
            },
          }
        );
        if (bodyTween.scrollTrigger) scrollTriggers.push(bodyTween.scrollTrigger);
      }

    } else {
      split.words.forEach((word: HTMLElement) => {
        if (word.dataset.highlight === 'true') {
          word.style.color = 'var(--color-accent)';
        }
      });
    }

    cleanupFn = () => {
      scrollTriggers.forEach((st) => st.kill());
      split.revert();
      unicornAborted = true;
      destroyUnicorn();
    };
  }

  // ===== Unicorn Studio WebGL scene =====
  let unicornScene: any = null;
  let unicornAborted = false;

  function initUnicorn() {
    const container = document.getElementById('unicorn-container');
    if (!container || unicornScene) return;

    const US = (window as any).UnicornStudio;
    if (!US) return;

    US.addScene({
      elementId: 'unicorn-container',
      projectId: 'ZDL0KUXvDVMNVAaFtwhX',
      scale: 1,
      dpi: 1.5,
      fps: 60,
      lazyLoad: true,
      production: true,
    }).then((scene: any) => {
      if (unicornAborted) {
        scene.destroy();
        return;
      }
      unicornScene = scene;
    }).catch(() => {});
  }

  function destroyUnicorn() {
    if (unicornScene) {
      unicornScene.destroy();
      unicornScene = null;
    }
  }

  initAbout();
  initUnicorn();

  document.addEventListener('astro:after-swap', () => {
    initAbout();
    initUnicorn();
  });
</script>
