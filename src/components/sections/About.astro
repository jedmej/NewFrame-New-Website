---
import type { Lang } from '../../i18n/translations';
import { useTranslations } from '../../i18n/translations';

interface Props {
  lang: Lang;
}

const { lang } = Astro.props;
const t = useTranslations(lang);
---

<section
  id="scope"
  class="relative min-h-screen border-t border-[var(--color-border)]"
  style="background-color: var(--color-bg);"
>
  <div class="w-full px-6 md:px-10 max-w-[1400px] mx-auto py-24 md:py-32 lg:py-40">

    <!-- Section label -->
    <div class="mb-8 md:mb-12">
      <span class="text-mono-xs text-[#0A0A0A]">{t.about.label}</span>
      <div class="mt-4 w-full h-px bg-[var(--color-text)]"></div>
    </div>

    <!-- Full-width manifesto text -->
    <p
      id="manifesto-text"
      class="text-serif-display leading-[1.25]"
      style="color: var(--color-text); font-size: clamp(1.5rem, 3.75vw, 3.375rem);"
      data-highlights={JSON.stringify(t.about.manifestoHighlights)}
    >
      {t.about.manifesto}
    </p>

    <!-- Organic lower section — image breaks the grid, text floats independently -->
    <div class="about-lower relative mt-12 md:mt-16 lg:mt-20">

      <!-- Image block: intentionally off-grid, centered-ish but shifted left -->
      <div class="about-image-wrapper relative md:absolute md:left-[12%] lg:left-[15%] md:top-0 z-10" style="width: min(100%, 480px);">
        <div
          id="about-image-block"
          class="relative overflow-hidden"
          style="aspect-ratio: 3/4; background-color: var(--color-text);"
        >
          <!-- Unicorn Studio WebGL scene -->
          <div
            id="unicorn-container"
            data-us-project="ZDL0KUXvDVMNVAaFtwhX"
            style="position: absolute; inset: 0; width: 100%; height: 100%;"
          ></div>

          <!-- Bottom-left detail -->
          <div class="absolute bottom-5 left-5 flex items-center gap-3 z-10">
            <span class="block w-6 h-px" style="background-color: var(--color-accent);"></span>
            <span class="text-mono-xs" style="color: rgba(255,255,255,0.35);">{t.about.founder}</span>
          </div>

          <!-- Top-right detail -->
          <div class="absolute top-5 right-5 z-10">
            <span class="text-mono-xs" style="color: rgba(255,255,255,0.2);">{t.about.role}</span>
          </div>
        </div>
      </div>

      <!-- Body text + links: pushed to the right, sits higher than image bottom -->
      <div class="about-text-wrapper relative z-20 mt-10 md:mt-0 md:ml-auto" style="max-width: 420px;">
        <p
          id="about-body"
          class="text-base md:text-lg leading-relaxed"
          style="font-family: var(--font-body); color: var(--color-text-muted);"
        >
          {t.about.body}
        </p>

        <!-- Link rows -->
        <nav id="about-links" class="mt-10 md:mt-14">
          {t.about.links.map((link, i) => (
            <a
              href={link.href}
              class="about-link-row group flex items-center justify-between py-4 border-t transition-all duration-500"
              style="border-color: var(--color-border-subtle);"
              data-link-index={i}
            >
              <span
                class="text-sm transition-all duration-500 group-hover:translate-x-2"
                style="font-family: var(--font-body); color: var(--color-text);"
              >
                {link.label}
              </span>
              <svg
                class="w-4 h-4 transition-all duration-500 group-hover:translate-x-1"
                style="color: var(--color-text-subtle);"
                fill="none" stroke="currentColor" viewBox="0 0 24 24"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 8l4 4m0 0l-4 4m4-4H3" />
              </svg>
            </a>
          ))}
          <div class="border-t" style="border-color: var(--color-border-subtle);"></div>
        </nav>
      </div>

    </div>
  </div>
</section>

<style>
  .manifesto-word {
    display: inline-block;
    will-change: opacity;
  }

  /* Mobile: stacked, no overlap */
  .about-lower {
    min-height: auto;
  }

  /* Tablet+: organic overlap layout */
  @media (min-width: 768px) {
    .about-lower {
      min-height: 520px;
    }

    .about-text-wrapper {
      /* Sits to the right, vertically offset from the image top */
      padding-top: 3rem;
      width: 40%;
      margin-right: 2%;
    }
  }

  /* Desktop: more dramatic offset */
  @media (min-width: 1024px) {
    .about-lower {
      min-height: 580px;
    }

    .about-image-wrapper {
      /* Nudge image down a touch so it doesn't start flush with the text */
      top: 1.5rem !important;
    }

    .about-text-wrapper {
      padding-top: 2rem;
      width: 36%;
      margin-right: 4%;
    }
  }
</style>

<script>
  import gsap from 'gsap';
  import { SplitText } from 'gsap/SplitText';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(SplitText, ScrollTrigger);

  function initAbout() {
    const section = document.getElementById('scope');
    const textEl = document.getElementById('manifesto-text');
    const imageBlock = document.getElementById('about-image-block');
    const bodyEl = document.getElementById('about-body');
    const linksEl = document.getElementById('about-links');

    if (!textEl || !section) return;

    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const highlights = JSON.parse(textEl.dataset.highlights || '[]') as string[];

    // ===== Word-by-word manifesto reveal =====

    const split = new SplitText(textEl, {
      type: 'words',
      wordsClass: 'manifesto-word',
    });

    split.words.forEach((word: HTMLElement) => {
      word.style.opacity = prefersReducedMotion ? '1' : '0.08';
      word.style.transition = 'none';
      word.style.display = 'inline-block';

      const text = word.textContent?.replace(/[^a-zA-ZąćęłńóśźżĄĆĘŁŃÓŚŹŻ]/g, '') || '';
      if (highlights.some((h: string) => text.toLowerCase() === h.toLowerCase())) {
        word.dataset.highlight = 'true';
      }
    });

    if (!prefersReducedMotion) {
      // Word reveal on scroll
      gsap.to(split.words, {
        opacity: 1,
        stagger: 0.02,
        ease: 'none',
        scrollTrigger: {
          trigger: textEl,
          start: 'top 80%',
          end: 'bottom 40%',
          scrub: 1,
          onUpdate: (self) => {
            const revealed = Math.floor(self.progress * split.words.length);
            split.words.forEach((word: HTMLElement, i: number) => {
              if (i <= revealed && word.dataset.highlight === 'true') {
                word.style.color = 'var(--color-accent)';
              }
            });
          },
        },
      });

      // Image block parallax — slightly different rate than text for organic feel
      if (imageBlock) {
        gsap.fromTo(imageBlock,
          { y: 50 },
          {
            y: -40,
            scrollTrigger: {
              trigger: imageBlock,
              start: 'top bottom',
              end: 'bottom top',
              scrub: 1,
            },
          }
        );
      }

      // Body text reveal
      if (bodyEl) {
        gsap.fromTo(bodyEl,
          { opacity: 0, y: 20 },
          {
            opacity: 1,
            y: 0,
            duration: 1,
            ease: 'power2.out',
            scrollTrigger: {
              trigger: bodyEl,
              start: 'top 85%',
              once: true,
            },
          }
        );
      }

      // Link rows staggered entrance
      if (linksEl) {
        const linkRows = linksEl.querySelectorAll('.about-link-row');
        gsap.fromTo(linkRows,
          { opacity: 0, x: 15 },
          {
            opacity: 1,
            x: 0,
            duration: 0.8,
            stagger: 0.12,
            ease: 'power2.out',
            scrollTrigger: {
              trigger: linksEl,
              start: 'top 85%',
              once: true,
            },
          }
        );
      }
    } else {
      split.words.forEach((word: HTMLElement) => {
        if (word.dataset.highlight === 'true') {
          word.style.color = 'var(--color-accent)';
        }
      });
    }

    // ===== Smooth scroll for link rows =====
    const linkRows = document.querySelectorAll('.about-link-row');
    linkRows.forEach((link) => {
      link.addEventListener('click', (e) => {
        const href = (link as HTMLAnchorElement).getAttribute('href');
        if (href?.startsWith('#')) {
          e.preventDefault();
          const target = document.querySelector(href);
          if (target) {
            const lenis = (window as any).lenis;
            if (lenis) {
              lenis.scrollTo(target);
            } else {
              target.scrollIntoView({ behavior: 'smooth' });
            }
          }
        }
      });
    });
  }

  // ===== Unicorn Studio WebGL scene =====
  let unicornScene: any = null;

  function initUnicorn() {
    const container = document.getElementById('unicorn-container');
    if (!container || unicornScene) return;

    const US = (window as any).UnicornStudio;
    if (!US) return;

    US.addScene({
      elementId: 'unicorn-container',
      projectId: 'ZDL0KUXvDVMNVAaFtwhX',
      scale: 1,
      dpi: 1.5,
      fps: 60,
      lazyLoad: true,
      production: true,
    }).then((scene: any) => {
      unicornScene = scene;
    }).catch(() => {});
  }

  function destroyUnicorn() {
    if (unicornScene) {
      unicornScene.destroy();
      unicornScene = null;
    }
  }

  initAbout();
  initUnicorn();

  document.addEventListener('astro:after-swap', () => {
    destroyUnicorn();
    initAbout();
    initUnicorn();
  });
</script>
