---
import type { Lang } from '../../i18n/translations';
import { useTranslations } from '../../i18n/translations';

interface Props {
  lang: Lang;
}

const { lang } = Astro.props;
const t = useTranslations(lang);
const items = t.testimonials.items;
const totalStr = String(items.length).padStart(2, '0');
---

<section
  id="testimonials"
  class="relative border-t border-[var(--color-border)]"
  style="background-color: var(--color-bg);"
>
  <!-- Scroll height container — creates the scroll distance for panels -->
  <div class="testimonial-scroll-height">

    <!-- Sticky viewport -->
    <div class="sticky top-0 h-screen flex items-center overflow-hidden">

      <!-- Top bar: label + counter -->
      <div class="absolute top-0 left-0 right-0 px-6 md:px-10 pt-8 z-20">
        <div class="flex justify-between items-center">
          <span class="text-mono-xs text-[var(--color-text-subtle)]">{t.testimonials.label}</span>
          <span id="testimonial-counter" class="text-mono-xs text-[var(--color-text-subtle)]">
            01 / {totalStr}
          </span>
        </div>
        <div class="mt-4 w-full h-px bg-[var(--color-text)]"></div>
      </div>

      <!-- Decorative: Large quote mark SVG -->
      <div class="absolute top-[12%] left-[5%] md:left-[8%] z-0 pointer-events-none" id="decorative-quote">
        <svg width="200" height="200" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-24 h-24 md:w-48 md:h-48 lg:w-64 lg:h-64">
          <path d="M80 40V140H20V90C20 62.4 42.4 40 70 40H80ZM180 40V140H120V90C120 62.4 142.4 40 170 40H180Z"
            stroke="var(--color-accent)" stroke-width="1.5" fill="none" opacity="0.06"/>
        </svg>
      </div>

      <!-- Decorative: Background panel index number -->
      <div
        id="testimonial-bg-number"
        class="absolute inset-0 flex items-center justify-center pointer-events-none z-0 select-none hidden md:flex"
      >
        <span
          class="text-transparent font-bold leading-none"
          style="font-family: var(--font-display); font-size: clamp(15rem, 30vw, 35rem); -webkit-text-stroke: 1px var(--color-text-faint); letter-spacing: -0.04em;"
        >
          01
        </span>
      </div>

      <!-- Testimonial panels container -->
      <div class="relative w-full px-6 md:px-10 max-w-[1100px] mx-auto z-10" style="min-height: 60vh;">
        {items.map((item, i) => (
          <div
            class="testimonial-panel absolute top-0 left-0 right-0 bottom-0 flex flex-col justify-center px-6 md:px-10"
            data-panel-index={i}
            data-highlights={JSON.stringify(item.highlights)}
            style={i === 0 ? 'opacity: 1;' : 'opacity: 0;'}
          >
            <!-- Quote -->
            <blockquote>
              <p
                class="testimonial-quote leading-[1.3] text-[var(--color-text)] max-w-[900px]"
                style={`font-family: var(--font-serif); font-size: clamp(1.4rem, 4vw, 3.5rem); letter-spacing: -0.02em;`}
              >
                &ldquo;{item.quote}&rdquo;
              </p>
            </blockquote>

            <!-- Author -->
            <div class="testimonial-author mt-8 md:mt-12 opacity-0" style="transform: translateY(20px);">
              <div class="flex items-center gap-3">
                <span class="w-6 h-px bg-[var(--color-accent)]"></span>
                <span class="text-mono-xs text-[var(--color-text)]">{item.name}</span>
              </div>
              <div class="ml-9">
                <span class="text-mono-xs text-[var(--color-text-subtle)]">{item.role}</span>
              </div>
            </div>
          </div>
        ))}
      </div>

      <!-- Bottom bar: dots + progress -->
      <div class="absolute bottom-0 left-0 right-0 px-6 md:px-10 pb-8 flex justify-between items-center z-20">
        <!-- Dot indicators -->
        <div class="flex items-center gap-2" id="testimonial-dots">
          {items.map((_, i) => (
            <span
              class="testimonial-dot w-2 h-2 rounded-full transition-all duration-500"
              data-dot-index={i}
              style={i === 0
                ? 'background-color: var(--color-accent);'
                : 'background-color: var(--color-text-ghost);'}
            ></span>
          ))}
        </div>

        <!-- Progress bar -->
        <div class="w-32 md:w-48 h-px bg-[var(--color-border-strong)] relative overflow-hidden">
          <div
            id="testimonial-progress"
            class="absolute inset-y-0 left-0 bg-[var(--color-accent)]"
            style="width: 0%; transition: none;"
          ></div>
        </div>
      </div>

    </div>
  </div>
</section>

<style>
  .testimonial-scroll-height {
    height: 300vh;
  }

  @media (min-width: 768px) {
    .testimonial-scroll-height {
      height: 350vh;
    }
  }

  @media (min-width: 1024px) {
    .testimonial-scroll-height {
      height: 400vh;
    }
  }

  .testimonial-panel {
    will-change: opacity, transform;
  }

  .quote-word {
    display: inline-block;
    will-change: opacity;
  }
</style>

<script>
  import gsap from 'gsap';
  import { SplitText } from 'gsap/SplitText';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(SplitText, ScrollTrigger);

  function initTestimonials() {
    const section = document.getElementById('testimonials');
    if (!section) return;

    const panels = section.querySelectorAll('.testimonial-panel');
    const counterEl = document.getElementById('testimonial-counter');
    const progressEl = document.getElementById('testimonial-progress');
    const bgNumberEl = document.getElementById('testimonial-bg-number');
    const bgNumberSpan = bgNumberEl?.querySelector('span');
    const dots = section.querySelectorAll('.testimonial-dot');
    const decorativeQuote = document.getElementById('decorative-quote');
    const totalPanels = panels.length;

    if (totalPanels === 0) return;

    // Check reduced motion preference
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    // Split each panel's quote into words
    const splits: any[] = [];
    panels.forEach((panel, i) => {
      const quoteEl = panel.querySelector('.testimonial-quote');
      if (!quoteEl) return;

      const highlights = JSON.parse((panel as HTMLElement).dataset.highlights || '[]') as string[];

      const split = new SplitText(quoteEl, {
        type: 'words',
        wordsClass: 'quote-word',
      });

      // Set initial ghost opacity and highlight colors
      split.words.forEach((word: HTMLElement) => {
        if (prefersReducedMotion) {
          word.style.opacity = '1';
        } else {
          word.style.opacity = '0.06';
        }
        word.style.display = 'inline-block';
        word.style.transition = 'none';

        // Check if word should be highlighted (keep hyphens for compound words)
        const text = word.textContent?.replace(/[^a-zA-ZąćęłńóśźżĄĆĘŁŃÓŚŹŻ\-]/g, '') || '';
        if (highlights.some((h: string) => text.toLowerCase() === h.toLowerCase())) {
          word.dataset.highlight = 'true';
        }
      });

      splits.push(split);
    });

    // Track current active panel
    let currentPanel = 0;

    // ===== MAIN SCROLL TRIGGER =====
    ScrollTrigger.create({
      trigger: section,
      start: 'top top',
      end: 'bottom bottom',
      scrub: 1,
      onUpdate: (self) => {
        const progress = self.progress;
        const panelProgress = progress * totalPanels;
        const activePanelIndex = Math.min(totalPanels - 1, Math.floor(panelProgress));
        const panelLocalProgress = panelProgress - activePanelIndex;

        // Update progress bar
        if (progressEl) {
          progressEl.style.width = `${progress * 100}%`;
        }

        // Update counter
        if (counterEl) {
          const displayIndex = String(activePanelIndex + 1).padStart(2, '0');
          const total = String(totalPanels).padStart(2, '0');
          counterEl.textContent = `${displayIndex} / ${total}`;
        }

        // Update background number
        if (bgNumberSpan) {
          bgNumberSpan.textContent = String(activePanelIndex + 1).padStart(2, '0');
        }

        // Update dot indicators
        dots.forEach((dot, i) => {
          const el = dot as HTMLElement;
          if (i === activePanelIndex) {
            el.style.backgroundColor = 'var(--color-accent)';
            el.style.transform = 'scale(1.3)';
          } else {
            el.style.backgroundColor = 'var(--color-text-ghost)';
            el.style.transform = 'scale(1)';
          }
        });

        // Panel visibility and word reveal
        panels.forEach((panel, i) => {
          const el = panel as HTMLElement;
          const authorEl = el.querySelector('.testimonial-author') as HTMLElement;
          const split = splits[i];

          if (i === activePanelIndex) {
            // Active panel
            el.style.opacity = '1';
            el.style.transform = 'translateY(0)';
            el.style.pointerEvents = 'auto';

            // Word reveal based on local progress
            if (split && !prefersReducedMotion) {
              const revealPhase = Math.min(1, panelLocalProgress / 0.65); // Words reveal in first 65% of panel scroll
              const wordsToReveal = Math.floor(revealPhase * split.words.length);

              split.words.forEach((word: HTMLElement, wi: number) => {
                if (wi <= wordsToReveal) {
                  word.style.opacity = '1';
                  if (word.dataset.highlight === 'true') {
                    word.style.color = 'var(--color-accent)';
                  }
                } else {
                  word.style.opacity = '0.06';
                  word.style.color = '';
                }
              });
            }

            // Author reveal at 50% panel progress
            if (authorEl) {
              if (panelLocalProgress > 0.5) {
                authorEl.style.opacity = '1';
                authorEl.style.transform = 'translateY(0)';
                authorEl.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
              } else {
                authorEl.style.opacity = '0';
                authorEl.style.transform = 'translateY(20px)';
                authorEl.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
              }
            }
          } else if (i < activePanelIndex) {
            // Previous panels — faded out above
            el.style.opacity = '0';
            el.style.transform = 'translateY(-30px)';
            el.style.pointerEvents = 'none';
            if (authorEl) {
              authorEl.style.opacity = '0';
              authorEl.style.transform = 'translateY(20px)';
            }
          } else {
            // Future panels — hidden below
            el.style.opacity = '0';
            el.style.transform = 'translateY(30px)';
            el.style.pointerEvents = 'none';
            if (authorEl) {
              authorEl.style.opacity = '0';
              authorEl.style.transform = 'translateY(20px)';
            }
            // Reset word opacity for future panels
            if (split && !prefersReducedMotion) {
              split.words.forEach((word: HTMLElement) => {
                word.style.opacity = '0.06';
                word.style.color = '';
              });
            }
          }
        });
      },
    });

    // ===== DECORATIVE PARALLAX =====
    if (decorativeQuote && !prefersReducedMotion) {
      gsap.to(decorativeQuote, {
        y: -100,
        rotation: 5,
        scrollTrigger: {
          trigger: section,
          start: 'top bottom',
          end: 'bottom top',
          scrub: 1,
        },
      });
    }

    // ===== BACKGROUND NUMBER PARALLAX =====
    if (bgNumberEl && !prefersReducedMotion) {
      gsap.to(bgNumberEl, {
        y: -60,
        scrollTrigger: {
          trigger: section,
          start: 'top bottom',
          end: 'bottom top',
          scrub: 1,
        },
      });
    }
  }

  initTestimonials();
  document.addEventListener('astro:after-swap', initTestimonials);
</script>
