---
import type { Lang } from '../../i18n/translations';
import { useTranslations } from '../../i18n/translations';

interface Props {
  lang: Lang;
}

const { lang } = Astro.props;
const t = useTranslations(lang);

const hoverImages = [
  'https://hoirqrkdgbmvpwutwuwj.supabase.co/storage/v1/object/public/assets/assets/917d6f93-fb36-439a-8c48-884b67b35381_1600w.jpg',
  'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=800&q=80',
  'https://images.unsplash.com/photo-1634017839464-5c339eba3df4?w=800&q=80',
  'https://images.unsplash.com/photo-1558618666-fcd25c85f82e?w=800&q=80',
  'https://images.unsplash.com/photo-1550745165-9bc0b252726f?w=800&q=80',
];
---

<section
  id="services"
  class="relative py-32 md:py-48 border-t border-[var(--color-border)]"
  style="background-color: var(--color-bg);"
>
  <div class="px-6 md:px-10 max-w-[1400px] mx-auto">
    <!-- Section label -->
    <div class="mb-12 md:mb-20">
      <span class="text-mono-xs text-[#0A0A0A]">{t.services.label}</span>
      <div class="mt-4 w-full h-px bg-[var(--color-text)]"></div>
    </div>

    <!-- Services list -->
    <div class="services-list">
      {t.services.items.map((service, i) => (
        <div class="service-row group" data-index={i}>
          <div class="service-line">
            <div class="service-line-fill"></div>
          </div>

          <div class="service-row-inner" data-cursor="VIEW">
            <h3 class="service-title">{service.title}</h3>
            <span class="service-num text-mono-xs text-[var(--color-accent)]">({service.num})</span>
          </div>

          <img
            class="service-hover-img"
            src={hoverImages[i]}
            alt={service.title}
            loading="lazy"
          />
        </div>
      ))}

      <div class="service-line">
        <div class="service-line-fill"></div>
      </div>
    </div>

    <!-- CTA -->
    <div class="service-cta mt-20 md:mt-32">
      <a
        href={`/${lang}/#contact`}
        id="services-cta-link"
        class="services-cta-block group"
        data-cursor="CLICK"
      >
        <div class="services-cta-inner">
          <h3 class="services-cta-text">{t.services.cta}</h3>
        </div>
        <div class="services-cta-icon">
          <svg id="cta-morph-svg" viewBox="0 0 566 566" fill="none" xmlns="http://www.w3.org/2000/svg">
            <!-- Logo path (single combined path for MorphSVG) -->
            <path id="cta-logo-path" d="M113,0 L453,0 L453,113 L113,113 Z M453,113 L566,113 L566,566 L453,566 Z M113,453 L453,453 L453,566 L113,566 Z M0,0 L113,0 L113,453 L0,453 Z" fill="currentColor" />
            <!-- Arrow target (hidden, used as morph target) -->
            <path id="cta-arrow-path" d="M478.297,337.073 L78.297,337.073 L78.297,238.073 L478.297,238.073 Z M212.132,70.711 L282.843,0 L564.978,282.136 L282.136,564.978 L212.132,494.975 L424.264,282.843 Z" fill="currentColor" style="visibility:hidden;position:absolute;" />
          </svg>
        </div>
        <div class="services-cta-inner">
          <h3 class="services-cta-text">{t.services.ctaRight}</h3>
        </div>
      </a>
    </div>
  </div>
</section>

<style>
  .service-line {
    width: 50%;
    margin-left: auto;
    height: 1px;
    background-color: var(--color-border-subtle);
    overflow: hidden;
  }

  .service-line-fill {
    width: 100%;
    height: 100%;
    background-color: var(--color-text);
    transform: scaleX(0);
    transform-origin: left;
  }

  .service-row-inner {
    display: flex;
    align-items: baseline;
    justify-content: flex-end;
    gap: 0.75rem;
    padding: 1rem 0;
    cursor: default;
  }

  @media (min-width: 768px) {
    .service-row-inner {
      padding: 1.25rem 0;
    }
  }

  .service-title {
    font-family: var(--font-serif);
    font-size: clamp(1rem, 1.8vw, 1.5rem);
    font-weight: 400;
    line-height: 1.2;
    letter-spacing: -0.01em;
    color: var(--color-text);
    transition: transform 0.6s var(--ease-out-expo), color 0.5s var(--ease-out-expo);
  }

  .service-row:hover .service-title {
    transform: translateX(-4px);
    color: var(--color-accent);
  }

  .service-row:hover .service-line .service-line-fill {
    background-color: var(--color-accent);
    transform: scaleX(1) !important;
    transition: transform 0.6s var(--ease-out-expo), background-color 0.3s;
  }

  /* ===== Giant CTA Block ===== */
  .services-cta-block {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 24px;
    padding: 2rem 0;
    cursor: pointer;
    text-decoration: none;
    color: var(--color-text);
  }

  @media (min-width: 768px) {
    .services-cta-block {
      padding: 2.5rem 0;
    }
  }

  .services-cta-inner {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .services-cta-text {
    font-family: var(--font-serif);
    font-size: clamp(1.2rem, 2vw, 1.5rem);
    font-style: italic;
    font-weight: 400;
    line-height: 1.3;
    letter-spacing: -0.01em;
    color: var(--color-text);
    transition: color 0.5s var(--ease-out-expo);
  }

  .services-cta-block:hover .services-cta-text {
    color: var(--color-accent);
  }

  .services-cta-icon {
    flex-shrink: 0;
    width: clamp(42px, 7.5vw, 105px);
    height: clamp(42px, 7.5vw, 105px);
    color: var(--color-text);
    transition: transform 0.6s var(--ease-out-expo), color 0.5s var(--ease-out-expo);
  }

  .services-cta-block:hover .services-cta-icon {
    color: var(--color-accent);
    transform: scale(1.1);
  }

  .services-cta-icon svg {
    width: 100%;
    height: 100%;
  }


  /* Hover image that follows cursor */
  .service-hover-img {
    position: fixed;
    top: 0;
    left: 0;
    width: 280px;
    height: 200px;
    object-fit: cover;
    pointer-events: none;
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    border-radius: 4px;
  }
</style>

<script>
  import gsap from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';
  import { ScrambleTextPlugin } from 'gsap/ScrambleTextPlugin';
  import { MorphSVGPlugin } from 'gsap/MorphSVGPlugin';

  gsap.registerPlugin(ScrollTrigger, ScrambleTextPlugin, MorphSVGPlugin);

  function initServices() {
    const section = document.getElementById('services');
    if (!section) return;

    const rows = section.querySelectorAll('.service-row');
    const lines = section.querySelectorAll('.service-line-fill');
    const cta = section.querySelector('.service-cta');

    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      lines.forEach((line) => {
        (line as HTMLElement).style.transform = 'scaleX(1)';
      });
      return;
    }

    // Lines draw in
    gsap.to(lines, {
      scaleX: 1,
      duration: 1,
      stagger: 0.1,
      ease: 'power3.inOut',
      scrollTrigger: {
        trigger: section,
        start: 'top 75%',
        once: true,
      },
    });

    // Rows stagger in
    rows.forEach((row, i) => {
      const inner = row.querySelector('.service-row-inner');
      if (!inner) return;

      gsap.fromTo(
        inner,
        { opacity: 0, y: 20 },
        {
          opacity: 1,
          y: 0,
          duration: 0.7,
          ease: 'power3.out',
          delay: 0.3 + i * 0.1,
          scrollTrigger: {
            trigger: section,
            start: 'top 75%',
            once: true,
          },
        },
      );
    });

    // Hover image follow cursor (CodePen PwqrzeG style)
    gsap.set('.service-hover-img', { xPercent: -50, yPercent: -50 });

    let firstEnter: boolean;

    const tilts = [-8, 5, -12, 7, -4];

    rows.forEach((row, i) => {
      const image = row.querySelector('.service-hover-img') as HTMLElement;
      if (!image) return;

      const tilt = tilts[i % tilts.length];
      gsap.set(image, { rotation: tilt });

      const setX = gsap.quickTo(image, 'x', { duration: 0.4, ease: 'power3' });
      const setY = gsap.quickTo(image, 'y', { duration: 0.4, ease: 'power3' });

      const align = (e: MouseEvent) => {
        if (firstEnter) {
          setX(e.clientX, e.clientX);
          setY(e.clientY, e.clientY);
          firstEnter = false;
        } else {
          setX(e.clientX);
          setY(e.clientY);
        }
      };

      const startFollow = () => document.addEventListener('mousemove', align);
      const stopFollow = () => document.removeEventListener('mousemove', align);

      const fade = gsap.to(image, {
        autoAlpha: 1,
        ease: 'none',
        paused: true,
        duration: 0.15,
        onReverseComplete: stopFollow,
      });

      // Scramble text on hover for service title
      const title = row.querySelector('.service-title');
      const titleOriginal = title?.textContent || '';

      row.addEventListener('mouseenter', (e) => {
        firstEnter = true;
        fade.play();
        startFollow();
        align(e as MouseEvent);

        if (title) {
          gsap.to(title, {
            duration: 0.5,
            scrambleText: { text: titleOriginal, chars: 'abcdefghijklmnopqrstuvwxyz', speed: 0.4 },
          });
        }
      });

      row.addEventListener('mouseleave', () => fade.reverse());
    });

    // CTA entrance animation
    if (cta) {
      const ctaTexts = cta.querySelectorAll('.services-cta-text');
      const ctaIcon = cta.querySelector('.services-cta-icon');

      const ctaTl = gsap.timeline({
        scrollTrigger: {
          trigger: cta,
          start: 'top 85%',
          once: true,
        },
      });

      ctaTl
        .fromTo(ctaTexts[0], { opacity: 0, y: 40 }, { opacity: 1, y: 0, duration: 0.8, ease: 'power3.out' })
        .fromTo(ctaIcon, { opacity: 0, scale: 0.6, rotation: -20 }, { opacity: 1, scale: 1, rotation: 0, duration: 0.7, ease: 'back.out(1.5)' }, '-=0.5')
        .fromTo(ctaTexts[1], { opacity: 0, y: 40 }, { opacity: 1, y: 0, duration: 0.8, ease: 'power3.out' }, '-=0.5');
    }

    // MorphSVG: logo â†’ arrow on hover
    const ctaLink = document.getElementById('services-cta-link');
    const logoPath = document.getElementById('cta-logo-path');
    const arrowPath = document.getElementById('cta-arrow-path');

    if (ctaLink && logoPath && arrowPath) {
      const arrowD = arrowPath.getAttribute('d')!;
      const logoD = logoPath.getAttribute('d')!;

      ctaLink.addEventListener('mouseenter', () => {
        gsap.to(logoPath, {
          morphSVG: arrowD,
          duration: 0.6,
          ease: 'expo.inOut',
        });
      });

      ctaLink.addEventListener('mouseleave', () => {
        gsap.to(logoPath, {
          morphSVG: logoD,
          duration: 0.6,
          ease: 'expo.inOut',
        });
      });
    }
  }

  initServices();
  document.addEventListener('astro:after-swap', initServices);
</script>
