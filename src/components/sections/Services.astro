---
import type { Lang } from '../../i18n/translations';
import { useTranslations } from '../../i18n/translations';

interface Props {
  lang: Lang;
}

const { lang } = Astro.props;
const t = useTranslations(lang);

const hoverImages = [
  'https://hoirqrkdgbmvpwutwuwj.supabase.co/storage/v1/object/public/assets/assets/917d6f93-fb36-439a-8c48-884b67b35381_1600w.jpg',
  'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=800&q=80',
  'https://images.unsplash.com/photo-1634017839464-5c339eba3df4?w=800&q=80',
  'https://images.unsplash.com/photo-1558618666-fcd25c85f82e?w=800&q=80',
  'https://images.unsplash.com/photo-1550745165-9bc0b252726f?w=800&q=80',
];
---

<section
  id="services"
  class="relative py-32 md:py-48 border-t border-[var(--color-border)]"
  style="background-color: var(--color-bg);"
>
  <div class="px-6 md:px-10 max-w-[1400px] mx-auto">
    <!-- Section label -->
    <div class="mb-12 md:mb-20">
      <span class="text-mono-xs text-[#0A0A0A]">{t.services.label}</span>
      <div class="mt-4 w-full h-px bg-[var(--color-text)]"></div>
    </div>

    <!-- Services list -->
    <div class="services-list">
      {t.services.items.map((service, i) => (
        <div class="service-row group" data-index={i}>
          <div class="service-line">
            <div class="service-line-fill"></div>
          </div>

          <div class="service-row-inner" data-cursor="VIEW">
            <h3 class="service-title">{service.title}</h3>
            <span class="service-num text-mono-xs text-[var(--color-accent)]">({service.num})</span>
          </div>

          <img
            class="service-hover-img"
            src={hoverImages[i]}
            alt={service.title}
            loading="lazy"
          />
        </div>
      ))}

      <div class="service-line">
        <div class="service-line-fill"></div>
      </div>
    </div>

    <!-- CTA -->
    <div class="service-cta mt-16 md:mt-24">
      <a
        href={`/${lang}/#contact`}
        class="magnetic-btn"
        data-magnetic
        data-cursor="CLICK"
      >
        {t.services.cta}
        <svg class="w-4 h-4 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 17L17 7M17 7H7M17 7v10" />
        </svg>
      </a>
    </div>
  </div>
</section>

<style>
  .service-line {
    width: 50%;
    margin-left: auto;
    height: 1px;
    background-color: var(--color-border-subtle);
    overflow: hidden;
  }

  .service-line-fill {
    width: 100%;
    height: 100%;
    background-color: var(--color-text);
    transform: scaleX(0);
    transform-origin: left;
  }

  .service-row-inner {
    display: flex;
    align-items: baseline;
    justify-content: flex-end;
    gap: 0.75rem;
    padding: 1rem 0;
    cursor: default;
  }

  @media (min-width: 768px) {
    .service-row-inner {
      padding: 1.25rem 0;
    }
  }

  .service-title {
    font-family: var(--font-serif);
    font-size: clamp(1rem, 1.8vw, 1.5rem);
    font-weight: 400;
    line-height: 1.2;
    letter-spacing: -0.01em;
    color: var(--color-text);
    transition: transform 0.6s var(--ease-out-expo), color 0.5s var(--ease-out-expo);
  }

  .service-row:hover .service-title {
    transform: translateX(-4px);
    color: var(--color-accent);
  }

  .service-row:hover .service-line .service-line-fill {
    background-color: var(--color-accent);
    transform: scaleX(1) !important;
    transition: transform 0.6s var(--ease-out-expo), background-color 0.3s;
  }

  /* Hover image that follows cursor */
  .service-hover-img {
    position: fixed;
    top: 0;
    left: 0;
    width: 280px;
    height: 200px;
    object-fit: cover;
    pointer-events: none;
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    border-radius: 4px;
  }
</style>

<script>
  import gsap from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';
  import { ScrambleTextPlugin } from 'gsap/ScrambleTextPlugin';

  gsap.registerPlugin(ScrollTrigger, ScrambleTextPlugin);

  function initServices() {
    const section = document.getElementById('services');
    if (!section) return;

    const rows = section.querySelectorAll('.service-row');
    const lines = section.querySelectorAll('.service-line-fill');
    const cta = section.querySelector('.service-cta');

    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      lines.forEach((line) => {
        (line as HTMLElement).style.transform = 'scaleX(1)';
      });
      return;
    }

    // Lines draw in
    gsap.to(lines, {
      scaleX: 1,
      duration: 1,
      stagger: 0.1,
      ease: 'power3.inOut',
      scrollTrigger: {
        trigger: section,
        start: 'top 75%',
        once: true,
      },
    });

    // Rows stagger in
    rows.forEach((row, i) => {
      const inner = row.querySelector('.service-row-inner');
      if (!inner) return;

      gsap.fromTo(
        inner,
        { opacity: 0, y: 20 },
        {
          opacity: 1,
          y: 0,
          duration: 0.7,
          ease: 'power3.out',
          delay: 0.3 + i * 0.1,
          scrollTrigger: {
            trigger: section,
            start: 'top 75%',
            once: true,
          },
        },
      );
    });

    // Hover image follow cursor (CodePen PwqrzeG style)
    gsap.set('.service-hover-img', { xPercent: -50, yPercent: -50 });

    let firstEnter: boolean;

    const tilts = [-8, 5, -12, 7, -4];

    rows.forEach((row, i) => {
      const image = row.querySelector('.service-hover-img') as HTMLElement;
      if (!image) return;

      const tilt = tilts[i % tilts.length];
      gsap.set(image, { rotation: tilt });

      const setX = gsap.quickTo(image, 'x', { duration: 0.4, ease: 'power3' });
      const setY = gsap.quickTo(image, 'y', { duration: 0.4, ease: 'power3' });

      const align = (e: MouseEvent) => {
        if (firstEnter) {
          setX(e.clientX, e.clientX);
          setY(e.clientY, e.clientY);
          firstEnter = false;
        } else {
          setX(e.clientX);
          setY(e.clientY);
        }
      };

      const startFollow = () => document.addEventListener('mousemove', align);
      const stopFollow = () => document.removeEventListener('mousemove', align);

      const fade = gsap.to(image, {
        autoAlpha: 1,
        ease: 'none',
        paused: true,
        duration: 0.15,
        onReverseComplete: stopFollow,
      });

      // Scramble text on hover for service title
      const title = row.querySelector('.service-title');
      const titleOriginal = title?.textContent || '';

      row.addEventListener('mouseenter', (e) => {
        firstEnter = true;
        fade.play();
        startFollow();
        align(e as MouseEvent);

        if (title) {
          gsap.to(title, {
            duration: 0.5,
            scrambleText: { text: titleOriginal, chars: 'abcdefghijklmnopqrstuvwxyz', speed: 0.4 },
          });
        }
      });

      row.addEventListener('mouseleave', () => fade.reverse());
    });

    // CTA fades in
    if (cta) {
      gsap.fromTo(
        cta,
        { opacity: 0, y: 20 },
        {
          opacity: 1,
          y: 0,
          duration: 0.8,
          ease: 'power3.out',
          scrollTrigger: {
            trigger: cta,
            start: 'top 90%',
            once: true,
          },
        },
      );
    }

    // Magnetic button
    const magneticBtns = section.querySelectorAll('[data-magnetic]');
    magneticBtns.forEach((btn) => {
      const el = btn as HTMLElement;

      el.addEventListener('mousemove', (e: MouseEvent) => {
        const rect = el.getBoundingClientRect();
        const x = e.clientX - rect.left - rect.width / 2;
        const y = e.clientY - rect.top - rect.height / 2;
        gsap.to(el, { x: x * 0.2, y: y * 0.2, duration: 0.3, ease: 'power2.out' });
      });

      el.addEventListener('mouseleave', () => {
        gsap.to(el, { x: 0, y: 0, duration: 0.5, ease: 'elastic.out(1, 0.5)' });
      });
    });
  }

  initServices();
  document.addEventListener('astro:after-swap', initServices);
</script>
