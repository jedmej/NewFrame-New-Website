---
import type { Lang } from '../../i18n/translations';
import { useTranslations } from '../../i18n/translations';

interface Props {
  lang: Lang;
}

const { lang } = Astro.props;
const t = useTranslations(lang);
---

<section
  id="services"
  class="relative py-32 md:py-48"
  style="background-color: var(--color-bg);"
>
  <div class="px-6 md:px-10 max-w-[1400px] mx-auto">
    <!-- Section label -->
    <div class="mb-12 md:mb-20">
      <h2 class="text-mono-xs text-[var(--color-text)]">{t.services.label}</h2>
      <div class="mt-4 w-full h-px bg-[var(--color-text)]" data-line></div>
    </div>

    <!-- Services grouped by category -->
    <div class="services-list">
      {t.services.groups.map((group, gi) => (
        <div class="service-group" data-group={gi}>
          <div class="service-group-inner">
            {/* Left: sticky category heading */}
            <div class="service-category-col">
              <h3 class="service-category">{group.category}</h3>
            </div>

            {/* Right: service items */}
            <div class="service-items-col">
              {group.items.map((service, si) => (
                <div class="service-row group" data-group-index={gi} data-item-index={si}>
                  {si > 0 && (
                    <div class="service-item-line">
                      <div class="service-line-fill"></div>
                    </div>
                  )}
                  <div class="service-row-inner">
                    <h4 class="service-title">{service.title}</h4>
                  </div>
                </div>
              ))}
              {/* Bottom line after last item */}
              <div class="service-item-line">
                <div class="service-line-fill"></div>
              </div>
            </div>
          </div>
        </div>
      ))}
    </div>

    <!-- CTA -->
    <div class="service-cta mt-20 md:mt-32">
      <a
        href={`/${lang}/#contact`}
        id="services-cta-link"
        class="services-cta-block group"
        data-cursor="CLICK"
        data-magnetic="0.4"
      >
        <div class="services-cta-inner">
          <h3 class="services-cta-text">{t.services.cta}</h3>
        </div>
        <div class="services-cta-icon">
          <svg id="cta-morph-svg" viewBox="0 0 566 566" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path id="cta-logo-path" d="M113,0 L453,0 L453,113 L113,113 Z M453,113 L566,113 L566,566 L453,566 Z M113,453 L453,453 L453,566 L113,566 Z M0,0 L113,0 L113,453 L0,453 Z" fill="currentColor" />
            <path id="cta-arrow-path" d="M478.297,337.073 L78.297,337.073 L78.297,238.073 L478.297,238.073 Z M212.132,70.711 L282.843,0 L564.978,282.136 L282.136,564.978 L212.132,494.975 L424.264,282.843 Z" fill="currentColor" style="visibility:hidden;position:absolute;" />
          </svg>
        </div>
        <div class="services-cta-inner">
          <h3 class="services-cta-text">{t.services.ctaRight}</h3>
        </div>
      </a>
    </div>
  </div>
</section>

<style>
  /* ===== Group layout ===== */
  .service-item-line {
    width: 100%;
    height: 1px;
    background-color: var(--color-border-subtle);
    overflow: hidden;
  }

  .service-line-fill {
    width: 100%;
    height: 100%;
    background-color: var(--color-text);
    transform: scaleX(0);
    transform-origin: left;
  }

  .service-group-inner {
    display: flex;
    flex-direction: row;
    gap: 0;
  }

  /* Left column: sticky category heading */
  .service-category-col {
    width: 35%;
    flex-shrink: 0;
    position: sticky;
    top: 3.5rem;
    align-self: flex-start;
    padding: 1rem 0;
    z-index: 1;
  }

  @media (min-width: 768px) {
    .service-category-col {
      width: 40%;
      padding: 1.5rem 0;
      top: 4.5rem;
    }
  }

  .service-category {
    font-family: var(--font-serif);
    font-size: clamp(2rem, 4vw, 3rem);
    font-weight: 400;
    line-height: 1.2;
    letter-spacing: -0.02em;
    color: var(--color-text);
  }

  /* Right column: service items */
  .service-items-col {
    flex: 1;
  }

  .service-row-inner {
    display: flex;
    align-items: baseline;
    justify-content: flex-end;
    gap: 0.75rem;
    padding: 0.875rem 0;
    cursor: default;
  }

  @media (min-width: 768px) {
    .service-row-inner {
      padding: 1.25rem 0;
    }
  }

  .service-title {
    font-family: var(--font-serif);
    font-size: clamp(1.5rem, 1.8vw, 2rem);
    font-weight: 400;
    line-height: 1.2;
    letter-spacing: -0.01em;
    color: var(--color-text);
    transition: transform 0.6s var(--ease-out-expo), color 0.5s var(--ease-out-expo);
  }

  .service-row:hover .service-title,
  .service-row.is-active .service-title {
    transform: translateX(-4px);
    color: var(--color-accent);
  }

  .service-row:hover .service-item-line .service-line-fill,
  .service-row.is-active .service-item-line .service-line-fill {
    background-color: var(--color-accent);
    transform: scaleX(1) !important;
    transition: transform 0.6s var(--ease-out-expo), background-color 0.3s;
  }

  /* ===== Giant CTA Block ===== */
  .services-cta-block {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 20px;
    padding: 2rem 0;
    cursor: pointer;
    text-decoration: none;
    color: var(--color-text);
  }

  @media (min-width: 768px) {
    .services-cta-block {
      flex-direction: row;
      gap: 24px;
      padding: 2.5rem 0;
    }
  }

  .services-cta-inner {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .services-cta-text {
    font-family: var(--font-serif);
    font-size: clamp(1.75rem, 3vw, 2.5rem);
    font-style: italic;
    font-weight: 400;
    line-height: 1.3;
    letter-spacing: -0.01em;
    color: var(--color-text);
    transition: color 0.5s var(--ease-out-expo);
  }

  .services-cta-block:hover .services-cta-text,
  .services-cta-block.is-active .services-cta-text {
    color: var(--color-accent);
  }

  .services-cta-icon {
    flex-shrink: 0;
    width: clamp(84px, 15vw, 210px);
    height: clamp(84px, 15vw, 210px);
    color: var(--color-text);
    transition: transform 0.6s var(--ease-out-expo), color 0.5s var(--ease-out-expo);
  }

  .services-cta-block:hover .services-cta-icon,
  .services-cta-block.is-active .services-cta-icon {
    color: var(--color-accent);
    transform: scale(1.1);
  }

  .services-cta-icon svg {
    width: 100%;
    height: 100%;
  }
</style>

<script>
  import gsap from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';
  import { ScrambleTextPlugin } from 'gsap/ScrambleTextPlugin';
  import { MorphSVGPlugin } from 'gsap/MorphSVGPlugin';

  gsap.registerPlugin(ScrollTrigger, ScrambleTextPlugin, MorphSVGPlugin);

  let cleanupFn: (() => void) | null = null;

  function initServices() {
    cleanupFn?.();
    cleanupFn = null;

    const section = document.getElementById('services');
    if (!section) return;

    const ac = new AbortController();
    const { signal } = ac;
    const scrollTriggers: ScrollTrigger[] = [];

    const rows = section.querySelectorAll('.service-row');
    const allLineFills = section.querySelectorAll('.service-line-fill');
    const cta = section.querySelector('.service-cta');
    const lines = section.querySelectorAll('[data-line]');

    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    if (prefersReducedMotion) {
      allLineFills.forEach((line) => {
        (line as HTMLElement).style.transform = 'scaleX(1)';
      });
      cleanupFn = () => ac.abort();
      return;
    }

    if (lines.length > 0) {
      gsap.set(lines, { scaleX: 0, transformOrigin: 'left' });
      const lineTween = gsap.to(lines, {
        scaleX: 1,
        duration: 0.8,
        ease: 'power3.out',
        scrollTrigger: {
          trigger: section,
          start: 'top 85%',
          once: true,
        },
      });
      if (lineTween.scrollTrigger) scrollTriggers.push(lineTween.scrollTrigger);
    }

    // Lines draw in
    const linesTween = gsap.to(allLineFills, {
      scaleX: 1,
      duration: 1,
      stagger: 0.08,
      ease: 'power3.inOut',
      scrollTrigger: {
        trigger: section,
        start: 'top 75%',
        once: true,
      },
    });
    if (linesTween.scrollTrigger) scrollTriggers.push(linesTween.scrollTrigger);

    // Rows stagger in
    rows.forEach((row, i) => {
      const inner = row.querySelector('.service-row-inner');
      if (!inner) return;

      const tween = gsap.fromTo(
        inner,
        { opacity: 0, y: 20 },
        {
          opacity: 1,
          y: 0,
          duration: 0.7,
          ease: 'power3.out',
          delay: 0.3 + i * 0.08,
          scrollTrigger: {
            trigger: section,
            start: 'top 75%',
            once: true,
          },
        },
      );
      if (tween.scrollTrigger) scrollTriggers.push(tween.scrollTrigger);
    });

    // Category headings fade in
    const categories = section.querySelectorAll('.service-category');
    categories.forEach((cat, i) => {
      const tween = gsap.fromTo(
        cat,
        { opacity: 0, y: 30 },
        {
          opacity: 1,
          y: 0,
          duration: 0.8,
          ease: 'power3.out',
          delay: 0.2 + i * 0.15,
          scrollTrigger: {
            trigger: cat,
            start: 'top 85%',
            once: true,
          },
        },
      );
      if (tween.scrollTrigger) scrollTriggers.push(tween.scrollTrigger);
    });

    const isTouch = window.matchMedia('(hover: none)').matches || window.innerWidth < 768;

    if (isTouch) {
      // Touch devices: scroll-triggered active state — only ONE row active at a time
      let activeIndex = -1;

      const activateRow = (index: number) => {
        if (index === activeIndex) return;
        activeIndex = index;
        rows.forEach((r, j) => {
          const el = r as HTMLElement;
          if (j === index) {
            el.classList.add('is-active');
          } else {
            el.classList.remove('is-active');
          }
        });
      };

      const deactivateAll = () => {
        if (activeIndex === -1) return;
        activeIndex = -1;
        rows.forEach((r) => {
          (r as HTMLElement).classList.remove('is-active');
        });
      };

      const servicesList = section.querySelector('.services-list') as HTMLElement;

      scrollTriggers.push(ScrollTrigger.create({
        trigger: servicesList,
        start: 'top 80%',
        end: 'bottom 20%',
        onUpdate: () => {
          const viewportCenter = window.innerHeight * 0.5;
          let closestIndex = -1;
          let closestDist = Infinity;

          rows.forEach((row, i) => {
            const rect = row.getBoundingClientRect();
            const rowCenter = rect.top + rect.height / 2;
            const dist = Math.abs(rowCenter - viewportCenter);
            if (dist < closestDist) {
              closestDist = dist;
              closestIndex = i;
            }
          });

          if (closestIndex >= 0 && closestDist < window.innerHeight * 0.3) {
            activateRow(closestIndex);
          } else {
            deactivateAll();
          }
        },
        onLeave: () => deactivateAll(),
        onLeaveBack: () => deactivateAll(),
      }));
    } else {
      // Desktop: scramble text on hover
      rows.forEach((row) => {
        const title = row.querySelector('.service-title');
        const titleOriginal = title?.textContent || '';

        row.addEventListener('mouseenter', () => {
          if (title) {
            gsap.to(title, {
              duration: 0.5,
              scrambleText: { text: titleOriginal, chars: 'abcdefghijklmnopqrstuvwxyz', speed: 0.4 },
            });
          }
        }, { signal });
      });
    }

    // CTA entrance animation
    if (cta) {
      const ctaTexts = cta.querySelectorAll('.services-cta-text');
      const ctaIcon = cta.querySelector('.services-cta-icon');

      const ctaTl = gsap.timeline({
        scrollTrigger: {
          trigger: cta,
          start: 'top 85%',
          once: true,
        },
      });
      if (ctaTl.scrollTrigger) scrollTriggers.push(ctaTl.scrollTrigger);

      ctaTl
        .fromTo(ctaTexts[0], { opacity: 0, y: 40 }, { opacity: 1, y: 0, duration: 0.8, ease: 'power3.out' })
        .fromTo(ctaIcon, { opacity: 0, scale: 0.6, rotation: -20 }, { opacity: 1, scale: 1, rotation: 0, duration: 0.7, ease: 'back.out(1.5)' }, '-=0.5')
        .fromTo(ctaTexts[1], { opacity: 0, y: 40 }, { opacity: 1, y: 0, duration: 0.8, ease: 'power3.out' }, '-=0.5');
    }

    // MorphSVG: logo → arrow on hover
    const ctaLink = document.getElementById('services-cta-link');
    const logoPath = document.getElementById('cta-logo-path');
    const arrowPath = document.getElementById('cta-arrow-path');

    if (ctaLink && logoPath && arrowPath) {
      const arrowD = arrowPath.getAttribute('d')!;
      const logoD = logoPath.getAttribute('d')!;

      // Desktop: hover morph
      ctaLink.addEventListener('mouseenter', () => {
        gsap.to(logoPath, {
          morphSVG: arrowD,
          duration: 0.6,
          ease: 'expo.inOut',
        });
      }, { signal });

      ctaLink.addEventListener('mouseleave', () => {
        gsap.to(logoPath, {
          morphSVG: logoD,
          duration: 0.6,
          ease: 'expo.inOut',
        });
      }, { signal });

      // Touch: scroll-triggered hover state when CTA is in viewport center
      if (isTouch) {
        scrollTriggers.push(ScrollTrigger.create({
          trigger: ctaLink,
          start: 'top 65%',
          end: 'bottom 35%',
          onEnter: () => {
            ctaLink.classList.add('is-active');
            gsap.to(logoPath, { morphSVG: arrowD, duration: 0.6, ease: 'expo.inOut' });
          },
          onLeave: () => {
            ctaLink.classList.remove('is-active');
            gsap.to(logoPath, { morphSVG: logoD, duration: 0.6, ease: 'expo.inOut' });
          },
          onEnterBack: () => {
            ctaLink.classList.add('is-active');
            gsap.to(logoPath, { morphSVG: arrowD, duration: 0.6, ease: 'expo.inOut' });
          },
          onLeaveBack: () => {
            ctaLink.classList.remove('is-active');
            gsap.to(logoPath, { morphSVG: logoD, duration: 0.6, ease: 'expo.inOut' });
          },
        }));
      }
    }

    cleanupFn = () => {
      ac.abort();
      scrollTriggers.forEach((st) => st.kill());
    };
  }

  initServices();
  document.addEventListener('astro:after-swap', initServices);
</script>
