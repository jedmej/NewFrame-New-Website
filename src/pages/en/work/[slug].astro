---
import Page from '../../../layouts/Page.astro';
import { projects, getProjectBySlug } from '../../../lib/projects';

export function getStaticPaths() {
  return projects.map((project) => ({
    params: { slug: project.slug },
  }));
}

const { slug } = Astro.params;
const project = getProjectBySlug(slug!);

if (!project) {
  return Astro.redirect('/en/work');
}

// Find next project for the "Next Project" link
const currentIndex = projects.findIndex((p) => p.slug === slug);
const nextProject = projects[(currentIndex + 1) % projects.length];
---

<Page lang="en" title={`${project.name} — New Frame Studio`}>
  <!-- Hero -->
  <section class="relative" style="background-color: var(--color-bg);">
    <div class="relative h-[70vh] md:h-[85vh] overflow-hidden">
      <img
        src={project.image}
        alt={project.name}
        class="w-full h-full object-cover"
        id="case-hero-img"
      />
      <div class="absolute inset-0 bg-gradient-to-t from-[var(--color-bg)] via-transparent to-transparent"></div>

      <!-- Project title overlay -->
      <div class="absolute bottom-0 left-0 right-0 px-6 md:px-10 pb-12 md:pb-20">
        <div class="max-w-[1400px] mx-auto">
          <span class="text-mono-xs text-[var(--color-text-muted)] block mb-4">{project.category}</span>
          <h1 id="case-title" class="text-display-lg text-[var(--color-text)]">{project.name}</h1>
        </div>
      </div>
    </div>
  </section>

  <!-- Meta + Description -->
  <section class="relative py-20 md:py-32" style="background-color: var(--color-bg-elevated);">
    <div class="px-6 md:px-10 max-w-[1400px] mx-auto">
      <div class="grid grid-cols-1 md:grid-cols-12 gap-12 md:gap-20">
        <!-- Meta sidebar -->
        <div class="md:col-span-4">
          <div class="space-y-8">
            <div>
              <span class="text-mono-xs text-[var(--color-text-subtle)] block mb-2">CLIENT</span>
              <span class="text-base font-medium text-[var(--color-text)]" style="font-family: var(--font-display);">{project.client}</span>
            </div>
            <div>
              <span class="text-mono-xs text-[var(--color-text-subtle)] block mb-2">YEAR</span>
              <span class="text-base font-medium text-[var(--color-text)]" style="font-family: var(--font-display);">{project.year}</span>
            </div>
            <div>
              <span class="text-mono-xs text-[var(--color-text-subtle)] block mb-2">ROLE</span>
              <span class="text-base font-medium text-[var(--color-text)]" style="font-family: var(--font-display);">{project.role}</span>
            </div>
            <div>
              <span class="text-mono-xs text-[var(--color-text-subtle)] block mb-2">TECH</span>
              <div class="flex flex-wrap gap-2">
                {project.tech.map((t) => (
                  <span class="text-mono-xs px-3 py-1.5 rounded-full text-[var(--color-text)]" style="border: 1px solid var(--color-border-strong);">
                    {t}
                  </span>
                ))}
              </div>
            </div>
          </div>
        </div>

        <!-- Description -->
        <div class="md:col-span-8">
          <p
            class="text-xl md:text-2xl leading-relaxed text-[var(--color-text)]"
            style="font-family: var(--font-display); font-weight: 500;"
          >
            {project.description.en}
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Gallery -->
  <section class="relative py-8" style="background-color: var(--color-bg-elevated);">
    <div class="px-6 md:px-10 max-w-[1600px] mx-auto">
      <div class="space-y-6">
        {project.gallery.map((img, i) => (
          <div class="case-gallery-img relative overflow-hidden rounded-xl">
            <img
              src={img}
              alt={`${project.name} — Gallery ${i + 1}`}
              class="w-full h-auto object-cover"
              loading="lazy"
            />
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Placeholder for more content -->
  <section class="relative py-24 md:py-32" style="background-color: var(--color-bg-elevated);">
    <div class="px-6 md:px-10 max-w-[1400px] mx-auto text-center">
      <p class="text-mono-xs text-[var(--color-text-subtle)]">FULL CASE STUDY COMING SOON</p>
    </div>
  </section>

  <!-- Next Project -->
  <a
    href={`/en/work/${nextProject.slug}`}
    class="group block relative overflow-hidden"
    style="background-color: var(--color-bg);"
  >
    <div class="relative h-[50vh] md:h-[60vh] overflow-hidden">
      <img
        src={nextProject.image}
        alt={nextProject.name}
        class="w-full h-full object-cover opacity-40 group-hover:opacity-60 group-hover:scale-105 transition-all duration-700"
        loading="lazy"
      />
      <div class="absolute inset-0 flex flex-col items-center justify-center">
        <span class="text-mono-xs text-[var(--color-text-muted)] mb-4">NEXT PROJECT</span>
        <h2
          class="text-display-md text-[var(--color-text)] group-hover:tracking-wider transition-all duration-500"
          style="mix-blend-mode: difference;"
        >
          {nextProject.name}
        </h2>
        <span class="text-mono-xs text-[var(--color-text-subtle)] mt-4">{nextProject.category}</span>
      </div>
    </div>
  </a>
</Page>

<script>
  import gsap from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  function initCaseStudy() {
    // Hero image parallax
    const heroImg = document.getElementById('case-hero-img');
    if (heroImg) {
      gsap.to(heroImg, {
        y: 80,
        scale: 1.05,
        scrollTrigger: {
          trigger: heroImg.parentElement,
          start: 'top top',
          end: 'bottom top',
          scrub: 1,
        },
      });
    }

    // Title animation
    const title = document.getElementById('case-title');
    if (title) {
      gsap.from(title, {
        y: 40,
        opacity: 0,
        duration: 0.8,
        ease: 'power3.out',
        delay: 0.3,
      });
    }

    // Gallery image reveals
    const galleryImgs = document.querySelectorAll('.case-gallery-img');
    galleryImgs.forEach((img) => {
      gsap.fromTo(img,
        { y: 40, opacity: 0 },
        {
          y: 0,
          opacity: 1,
          duration: 0.8,
          ease: 'power3.out',
          scrollTrigger: {
            trigger: img,
            start: 'top 85%',
          },
        }
      );
    });
  }

  initCaseStudy();
  document.addEventListener('astro:after-swap', initCaseStudy);
</script>
